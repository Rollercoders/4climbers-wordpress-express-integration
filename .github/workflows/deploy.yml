name: Deploy to Wordpress

on:
  push:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check commit message
      id: check-commit
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        if [[ "$COMMIT_MSG" =~ ^(feat|fix:|revert:) ]] || [[ "$COMMIT_MSG" == *"[DEPLOY]"* ]]; then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Commit message starts with allowed prefix: $COMMIT_MSG"
        else
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è Skipping deployment - commit message doesn't start with feat, fix:, revert:, or contain [DEPLOY]"
          echo "Commit message: $COMMIT_MSG"
        fi

    - name: Capture commit info
      if: steps.check-commit.outputs.should_deploy == 'true'
      id: commit_info
      run: |
        echo "commit_message=${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
        echo "commit_timestamp=${{ github.event.head_commit.timestamp }}" >> $GITHUB_OUTPUT

    - name: Setup PHP
      if: steps.check-commit.outputs.should_deploy == 'true'
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, json, tokenizer, openssl

    - name: Cache Composer packages
      if: steps.check-commit.outputs.should_deploy == 'true'
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      if: steps.check-commit.outputs.should_deploy == 'true'
      run: composer update --prefer-dist --no-progress --optimize-autoloader --no-dev

    - name: Update version number
      id: get_new_version
      if: steps.check-commit.outputs.should_deploy == 'true' && github.ref == 'refs/heads/develop'
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        CURRENT_VERSION=$(grep -oP 'Version: \K[0-9]+\.[0-9]+\.[0-9]+' 4climbers-wordpress-express-integration.php)
        
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        
        if [[ "$COMMIT_MSG" =~ ^feat! ]]; then
          # Breaking change - increment major version
          major=$((major + 1))
          minor=0
          patch=0
          echo "üöÄ Breaking change detected - incrementing major version"
        elif [[ "$COMMIT_MSG" =~ ^feat ]]; then
          # New feature - increment minor version
          minor=$((minor + 1))
          patch=0
          echo "‚ú® New feature detected - incrementing minor version"
        elif [[ "$COMMIT_MSG" =~ ^(fix|revert) ]]; then
          # Bug fix or revert - increment patch version
          patch=$((patch + 1))
          echo "üêõ Bug fix/revert detected - incrementing patch version"
        else
          echo "‚ÑπÔ∏è No version increment needed for this commit type"
          exit 0
        fi
        
        NEW_VERSION="$major.$minor.$patch"
        echo "üìù Updating version from $CURRENT_VERSION to $NEW_VERSION"
        
        # Update the version in the PHP file
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" 4climbers-wordpress-express-integration.php
        
        # Verify the change
        grep "Version:" 4climbers-wordpress-express-integration.php
        
        # Publish the new version as output
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Deploy via FTP
      if: steps.check-commit.outputs.should_deploy == 'true'
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /public_html/wp-content/plugins/4climbers-wordpress-express-integration/
        exclude: |
          **/.git*
          **/.git*/**
          .github/
          README.md

    - name: Commit & Push
      if: steps.check-commit.outputs.should_deploy == 'true'
      run: |
        git config user.name "GitHub Actions CLI"
        git config user.email "actionscli@github.com"
        git add 4climbers-wordpress-express-integration.php
        git commit -m "chore: release v${{ steps.get_new_version.outputs.new-version }}"
        git push origin develop


    - name: Notify Telegram of new Release
      if: steps.check-commit.outputs.should_deploy == 'true'
      uses: appleboy/telegram-action@v0.1.0
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          üéâ *NUOVA VERSIONE DEL PLUGIN WORDPRESS RILASCIATA!* üéâ

          üÜï *Versione:* `${{ steps.get_new_version.outputs.new-version }}`
          üëë *Ambiente:* staging
          ‚úèÔ∏è *Commit:* _${{ steps.commit_info.outputs.commit_message }}_
          üïí *Data:* `${{ steps.commit_info.outputs.commit_timestamp }}`

          üöÄ _Let's Goooooo!_
        format: Markdown
