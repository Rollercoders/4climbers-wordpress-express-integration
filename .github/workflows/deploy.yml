name: Deploy to Wordpress

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
      - '!**-dev'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check commit message
      id: check-commit
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")

        # Deploy sempre sui tag che non finiscono con -dev, controlla il messaggio solo su develop
        if [[ "${{ github.ref }}" == refs/tags/* ]] && [[ ! "${{ github.ref }}" =~ -dev$ ]]; then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Production tag detected - deploying to production"
        elif [[ "${{ github.ref }}" == "refs/heads/develop" && "$COMMIT_MSG" =~ ^(feat|fix:|revert:) ]] || [[ "$COMMIT_MSG" == *"[DEPLOY]"* ]]; then
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Commit message starts with allowed prefix: $COMMIT_MSG"
        else
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ Skipping deployment - commit message doesn't start with feat, fix:, revert:, or contain [DEPLOY]"
          echo "Commit message: $COMMIT_MSG"
        fi

    - name: Capture commit info
      if: steps.check-commit.outputs.should_deploy == 'true'
      id: commit_info
      run: |
        echo "commit_message=${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
        echo "commit_timestamp=${{ github.event.head_commit.timestamp }}" >> $GITHUB_OUTPUT

    - name: Setup PHP
      if: steps.check-commit.outputs.should_deploy == 'true'
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, json, tokenizer, openssl

    - name: Cache Composer packages
      if: steps.check-commit.outputs.should_deploy == 'true'
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      if: steps.check-commit.outputs.should_deploy == 'true'
      run: composer update --prefer-dist --no-progress --optimize-autoloader --no-dev

    - name: Update version number
      id: get_new_version
      if: steps.check-commit.outputs.should_deploy == 'true'
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        CURRENT_VERSION=$(grep -oP 'Version: \K[0-9]+\.[0-9]+\.[0-9]+' 4climbers-wordpress-express-integration.php)
        
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        
        if [[ "$COMMIT_MSG" =~ ^feat! ]]; then
          # Breaking change - increment major version
          major=$((major + 1))
          minor=0
          patch=0
          echo "ðŸš€ Breaking change detected - incrementing major version"
        elif [[ "$COMMIT_MSG" =~ ^feat ]]; then
          # New feature - increment minor version
          minor=$((minor + 1))
          patch=0
          echo "âœ¨ New feature detected - incrementing minor version"
        elif [[ "$COMMIT_MSG" =~ ^(fix|revert) ]]; then
          # Bug fix or revert - increment patch version
          patch=$((patch + 1))
          echo "ðŸ› Bug fix/revert detected - incrementing patch version"
        else
          echo "â„¹ï¸ No version increment needed for this commit type"
          exit 0
        fi
        
        NEW_VERSION="$major.$minor.$patch"
        echo "ðŸ“ Updating version from $CURRENT_VERSION to $NEW_VERSION"
        
        # Update the version in the PHP file
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" 4climbers-wordpress-express-integration.php
        
        # Verify the change
        grep "Version:" 4climbers-wordpress-express-integration.php
        
        # Publish the new version as output
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Deploy via FTP (Staging)
      if: steps.check-commit.outputs.should_deploy == 'true'
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /public_html/wp-content/plugins/4climbers-wordpress-express-integration/
        exclude: |
          **/.git*
          **/.git*/**
          .github/
          README.md

    - name: Deploy via FTP (Production)
      if: startsWith(github.ref, 'refs/tags/') && !endsWith(github.ref, '-dev')
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME_PROD }}
        password: ${{ secrets.FTP_PASSWORD_PROD }}
        local-dir: ./
        server-dir: /public_html/wp-content/plugins/4climbers-wordpress-express-integration/
        exclude: |
          **/.git*
          **/.git*/**
          .github/
          README.md

    - name: Create Release Tag
      if: steps.check-commit.outputs.should_deploy == 'true' && github.ref == 'refs/heads/develop' && steps.get_new_version.outputs.new-version != ''
      run: |
        git config user.name "GitHub Actions CLI"
        git config user.email "actionscli@github.com"
        git tag -a "${{ steps.get_new_version.outputs.new-version }}-dev" -m "Release version ${{ steps.get_new_version.outputs.new-version }}"
        git push origin "${{ steps.get_new_version.outputs.new-version }}-dev"


    - name: Notify Telegram (Staging)
      if: steps.check-commit.outputs.should_deploy == 'true'
      uses: appleboy/telegram-action@v0.1.0
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ðŸŽ‰ *NUOVA VERSIONE DEL PLUGIN WORDPRESS RILASCIATA!* ðŸŽ‰

          ðŸ†• *Versione:* `${{ steps.get_new_version.outputs.new-version }}`
          ðŸ‘‘ *Ambiente:* staging
          âœï¸ *Commit:* _${{ steps.commit_info.outputs.commit_message }}_
          ðŸ•’ *Data:* `${{ steps.commit_info.outputs.commit_timestamp }}`

          ðŸš€ _Let's Goooooo!_
        format: Markdown

    - name: Get tag version for production
      if: startsWith(github.ref, 'refs/tags/') && !endsWith(github.ref, '-dev')
      id: tag_version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "commit_timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

    - name: Notify Telegram (Production)
      if: startsWith(github.ref, 'refs/tags/') && !endsWith(github.ref, '-dev')
      uses: appleboy/telegram-action@v0.1.0
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ðŸš€ *DEPLOY IN PRODUZIONE COMPLETATO!* ðŸš€

          ðŸ“¦ *Plugin:* 4Climbers WordPress Express Integration
          ðŸ†• *Versione:* `${{ steps.tag_version.outputs.tag_name }}`
          ðŸ‘‘ *Ambiente:* production
          ðŸ•’ *Data:* `${{ steps.tag_version.outputs.commit_timestamp }}`

          âœ… _Deploy completato con successo!_
        format: Markdown
